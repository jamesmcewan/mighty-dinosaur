image: oven/bun:1.3

stages:
  - check
  - build
  - deploy

variables:
  BUN_INSTALL_CACHE_DIR: .bun-cache

cache:
  key:
    files:
      - bun.lockb
  paths:
    - .bun-cache/
    - node_modules/

# Install dependencies (shared across jobs)
.install_deps: &install_deps
  - bun install

# Branch checks job (runs on all branches except main)
format:check:
  stage: check
  script:
    - *install_deps
    - bun run format:check
  rules:
    - if: $CI_COMMIT_BRANCH != "main"

lint:check:
  stage: check
  script:
    - *install_deps
    - bun run lint:check
  rules:
    - if: $CI_COMMIT_BRANCH != "main"

build:branch:
  stage: build
  script:
    - *install_deps
    - bun run build
  rules:
    - if: $CI_COMMIT_BRANCH != "main"
  artifacts:
    paths:
      - dist/
    expire_in: 1 day

# Main branch checks and deployment
format:check:main:
  stage: check
  script:
    - *install_deps
    - bun run format:check
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

lint:check:main:
  stage: check
  script:
    - *install_deps
    - bun run lint:check
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

build:main:
  stage: build
  script:
    - *install_deps
    - bun run build
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  artifacts:
    paths:
      - dist/
    expire_in: 1 day

deploy:bunnycdn:
  stage: deploy
  image: alpine:latest
  script:
    - apk add --no-cache curl jq
    # Upload files to BunnyCDN Storage
    - |
      cd dist
      find . -type f | while read file; do
        filepath="${file#./}"
        curl -X PUT \
          "${BUNNY_STORAGE_ENDPOINT}/${BUNNY_STORAGE_ZONE}/${filepath}" \
          -H "AccessKey: ${BUNNY_STORAGE_PASSWORD}" \
          --data-binary "@${file}"
      done
    # Purge pull zone cache
    - |
      curl -X POST \
        "https://api.bunny.net/pullzone/${BUNNY_PULL_ZONE_ID}/purgeCache" \
        -H "AccessKey: ${BUNNY_API_KEY}"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  needs:
    - build:main
  environment:
    name: production
    url: https://mightydinosaur.dev
